stages:
  - fortify

variables:
  APM_ID: APM0008206
  SCAN_VERSION: image-pull-secret-replicator
  BUILD_IMAGE: fmk.nexus.onefiserv.net/fmk/dotnet/dotnet-8.0-build
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "true"
  DOTNET_NUGET_SIGNATURE_VERIFICATION: "false"

fortify-scan:
  stage: fortify
  image: "$BUILD_IMAGE:FMK-20250401T173337Z"
  script:
    - echo "Running Fortify scan for $APM_ID - $SCAN_VERSION"
    - mkdir -p artifacts/fortify
    - pwsh -NoProfile /etc/fortify/bin/Start-FortifyScan.ps1 `
        -BuildId "$CI_PIPELINE_ID" `
        -Source . `
        -Application "$APM_ID" `
        -Version "$SCAN_VERSION" `
        -Token "$FORTIFY_TOKEN" `
        -Email "$FORTIFY_EMAIL" `
        -OutputFolder artifacts/fortify `
        -Publish
    - pwsh -NoProfile ./build/pipeline/Write-FortifyIssues.ps1 `
        -FortifyReportsDirectory ./artifacts/fortify `
        -FortifyJson ./.fortify.json
  artifacts:
    when: always
    paths:
      - artifacts/fortify/
      - .fortify.json