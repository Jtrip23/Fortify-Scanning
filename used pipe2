fortify-scan:
  stage: fortify
  image: "$BUILD_IMAGE:FMK-20250401T173337Z"

  script:
    - echo "Cloning external repo..."
    - git clone "$EXTERNAL_REPO" "$EXTERNAL_REPO_DIR"

    - echo "Zipping source code from $EXTERNAL_REPO_DIR"
    - mkdir -p artifacts/fortify
    - zip -r artifacts/fortify/source.zip "$EXTERNAL_REPO_DIR"

    - echo "Running Fortify scan"
    - |
      pwsh -NoProfile /etc/fortify/bin/Start-FortifyScan.ps1 `
        -BuildId "ext-$(date +%s)" `
        -Source "$EXTERNAL_REPO_DIR" `
        -Application "$APM_ID" `
        -Version "$SCAN_VERSION" `
        -Token "$FORTIFY_TOKEN" `
        -Email "$FORTIFY_EMAIL" `
        -OutputFolder "artifacts/fortify"

    - |
      pwsh -NoProfile ./build/pipeline/Write-FortifyIssues.ps1 `
        -FortifyReportsDirectory "./artifacts/fortify" `
        -FortifyJson "./.fortify.json"

    - |
      scancentral -sscurl "$SSC_URL" -ssctoken "$SSC_TOKEN" start -upload `
        -application "$APM_ID" `
        -version "$FORTIFY_VERSION" `
        -uptoken "$SSC_UPLOAD_TOKEN" `
        -email "$FORTIFY_NOTIFICATION_DL" `
        -bt none

  artifacts:
    when: always
    paths:
      - artifacts/fortify/
      - .fortify.json

  tags:
    - apimhub