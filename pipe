stages:
  - build
  - scan

variables:
  IMAGE_TAG: "FMK-20250401T173337Z"
  BASE_IMAGE: "fmk.nexus.onefiserv.net/fmk/dotnet/dotnet-8.0-build:${IMAGE_TAG}"
  BUILD_ID: "${CI_COMMIT_BRANCH}-${CI_COMMIT_SHORT_SHA}"
  ARTIFACTS_DIR: "/app/artifacts"

default:
  image: $BASE_IMAGE
  before_script:
    - mkdir -p artifacts

build-dotnet:
  stage: build
  script:
    - echo "Building .NET project..."
    - dotnet msbuild ./default.proj
  artifacts:
    paths:
      - artifacts/
    expire_in: 1 week

fortify-scan:
  stage: scan
  script:
    - echo "Running Fortify scan and publishing..."
    - |
      Start-FortifyScan.ps1 `
        -BuildId "$BUILD_ID" `
        -Source /app `
        -Application "$FORTIFY_APPLICATION" `
        -Version "$FORTIFY_VERSION" `
        -Token "$SSC_TOKEN" `
        -Email "$FORTIFY_NOTIFICATION_DL" `
        -OutputFolder /app/artifacts `
        -Publish
  artifacts:
    paths:
      - artifacts/
    expire_in: 2 weeks