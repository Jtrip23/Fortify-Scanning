stages:
  - scan

variables:
  IMAGE_NAME: "fmk.nexus.onefiserv.net/fmk/dotnet/dotnet-8.0-build:FMK-20250401T173337Z"
  BUILD_ID: "${CI_COMMIT_BRANCH}-${CI_COMMIT_SHORT_SHA}"
  SOURCE_DIR: "/app"
  OUTPUT_FOLDER: "/app/artifacts"
  FORTIFY_APP: "APMXXXXX"
  FORTIFY_VERSION: "1.0"

fortify-scan:
  stage: scan
  tags:
    - docker
  image: docker:latest
  services:
    - docker:dind
  script:
    - mkdir -p artifacts
    - >
      docker run -i --rm 
      -v "$CI_PROJECT_DIR:/app" 
      "$IMAGE_NAME" 
      Start-FortifyScan.ps1 
      -BuildId "$BUILD_ID" 
      -Source "$SOURCE_DIR" 
      -Application "$FORTIFY_APP" 
      -Version "$FORTIFY_VERSION" 
      -Token "$SSC_TOKEN" 
      -Email "$FORTIFY_NOTIFICATION_DL" 
      -OutputFolder "$OUTPUT_FOLDER" 
      -Publish
  artifacts:
    paths:
      - artifacts/
    expire_in: 1 week 